<!DOCTYPE html>
<head>

    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="//xoxco.com/projects/code/tagsinput/jquery.tagsinput.css" />
    
    <link rel="stylesheet" class="cssStatics" type="text/css" href="Facebook-Link-Preview-master/css/stylesheet.css" />
    <link rel="stylesheet" class="cssButtons" type="text/css" href="Facebook-Link-Preview-master/css/linkPreview.css" />
    <script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="Facebook-Link-Preview-master/js/linkPreview.js" ></script>
    <script type="text/javascript" src="Facebook-Link-Preview-master/js/linkPreviewRetrieve.js" ></script>
    
    <script type="text/javascript">
    var Keen=Keen||{configure:function(e){this._cf=e},addEvent:function(e,t,n,i){this._eq=this._eq||[],this._eq.push([e,t,n,i])},setGlobalProperties:function(e){this._gp=e},onChartsReady:function(e){this._ocrq=this._ocrq||[],this._ocrq.push(e)}};(function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://":"http://")+"dc8na2hxrj29i.cloudfront.net/code/keen-2.1.0-min.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})();

    // Configure the Keen object with your Project ID and (optional) access keys.
    Keen.configure({
        projectId: "52c6e20836bf5a6dd0000015",
        writeKey: "d523d28ca0cf1406ac6a4275d70c09f31e06fa575355a163f411a81ae4b9caabc73c211a53c93c14286da3e33ebfcb3696e8e5973da40ac16035c28c8f8c38eabcdc6fa15f2474edc748212d748475a62d59d6bcf9479b6b10fa187ae42f1245663fedbeabcc6af28df2dec0f2ff5b0d", // required for sending events
        readKey: "98ec71562a7174440c4b628f1871282e333dd4e7df76994e3ebc269f49bea6bc356b567e8db69b5a0735d3bd3221cf31ebf5c4c780e61a5388f1550616536c286ecbdad69994dd51c183333c05e7fbe0f51ed695301c7470f6e3cceb2ca5db9c3d81593f41dd26419d5e96460f44380c"    // required for doing analysis
    });
</script>
</head>
<body>
<div class="navigation">
	<div class="navwidth">
		<a href="http://zacomments.azurewebsites.net/"><img class="logo" src="images/logo.png"/></a>
		<input class="search" type="text" id="searchField" id="tags"></input>
    		<button class="searchbtn" type="button" id="search">Search</button>
    		<div class="account" data-hull-component="login/profile@hull" data-hull-provider="facebook"></div>
	</div>
</div>
<div class="body">
	<div class="col1">
		<div class="createbuzz">
	    <h1>Create new Buzz</h1>
    <input type="text" placeholder="Write Topic" id="newEntityField"></input>
    <input type="text" placeholder="Insert Tags" id="tagsField"></input>
    <button type="button" id="createTopic">Create Topic</button>
    		</div>
    
    <div class="trendingbuzz">
    <script type='text/x-handlebars' data-hull-template='posts/posts'>
                <h1>Trending Buzz</h1>
        {{#each trendingPosts}}
            {{#if name}}
                <div class="trendingbuzz">
                <h1 class="post" data-postID="{{id}}"><a href="#/post/{{id}}">{{name}}</a></h1>
                {{#if picture}}
                    <img src="{{imageUrl picture 'small' 'http://placehold.it/200x200'}}"/> 
                {{/if}}
                {{#if tags}}
                    </div>
                    {{#each tags}}
                        {{#if this}}
                            <li><a href="#/post/{{this.value}}">{{this.label}}</a></li>
                        {{/if}}
                    {{/each}}
                {{/if}}
                <div class="loading">
                     <img src="https://f.cloud.github.com/assets/6652042/2208623/dcefa538-9981-11e3-895e-5a09c35c265d.gif" alt="Loading" width="42" height="42"> 
                </div>
                <p>{{stats.comments}} comments</p>
                <div data-hull-component="test" data-hull-id="{{id}}" data-hull-orderby="votes"></div>
            {{/if}}
        {{/each}}
        <button type="button" id="loadMoreTrending" data-hull-action="loadMoreTrending">Load More Trending Topics</button>
        </div>

	<div class="newbuzz">
        <h1>New Buzz</h1>
        {{#each newPosts}}
            {{#if name}}
                <div>
                <h1 class="post" data-postID="{{id}}"><a href="#/post/{{id}}">{{name}}</a></h1>
                {{#if picture}}
                    <img src="{{imageUrl picture 'small' 'http://placehold.it/200x200'}}"/> 
                {{/if}}
                
                {{#if tags}}
                    </div>
                    Tags:
                    {{#each tags}}
                        {{#if this}}
                            <li><a href="#/post/{{this.value}}">{{this.label}}</a></li>
                        {{/if}}
                    {{/each}}
                {{/if}}
                <div class="loading">
                     <img src="https://f.cloud.github.com/assets/6652042/2208623/dcefa538-9981-11e3-895e-5a09c35c265d.gif" alt="Loading" width="42" height="42"> 
                </div>
                <p>{{stats.comments}} comments</p>
                <div data-hull-component="test" data-hull-id="{{id}}" data-hull-orderby="votes"></div>
            {{/if}}
        {{/each}}
        <button type="button" id="loadMore" data-hull-action="loadMore">Load More New Posts</button>
        </div>

      </script>
        
    <script type='text/x-handlebars' data-hull-template='posts/post'}>
        <div class="loading">
            <img src="https://f.cloud.github.com/assets/6652042/2208623/dcefa538-9981-11e3-895e-5a09c35c265d.gif" alt="Loading" width="42" height="42"> 
        </div>
        <div data-hull-component="post" data-hull-id="{{id}}"></div>
    </script>
    
    <script type='text/x-handlebars' data-hull-template='user/user'}>
        <button type="button" id="back" data-hull-action="back">&lt&ltBack</button>
        {{#each feed}}
            {{#ifEqual object.type "comment"}}
                {{#if target.name}}
                    <p>commented on <a href="#/post/{{target.id}}">{{target.name}}</a></p>
                {{/if}}
            {{else}}
                <p>reviewed a comment on a <a href="#/post/{{target.commentable_id}}">post</a></p>
            {{/ifEqual}}
        {{/each}}
    </script>
    
    <script type='text/x-handlebars' data-hull-template='search/search'}>
        <button type="button" id="back" data-hull-action="back">&lt&ltBack</button>
        <h1>Search Results</h1>
        {{#each searchResults}}
            {{#if name}}
                <h1 class="post" data-postID="{{id}}"><a href="#/post/{{id}}">{{name}}</a></h1>
		<p>{{stats.comments}} comments</p>
            {{/if}}
        {{/each}}
    </script>
    
     <script type='text/x-handlebars' data-hull-template='posts/user'}>
         <div data-hull-component="user" data-hull-id="{{id}}"></div>
    </script>
    
    <script type='text/x-handlebars' data-hull-template='posts/search'}>
         <div data-hull-component="search" data-hull-search="{{id}}"></div>
    </script>
    
    <script type='text/x-handlebars' data-hull-template='posts/createtopic'}>
        <div data-hull-component="createtopic" data-hull-id="{{id}}"></div>
    </script>
        
    <script type='text/x-handlebars' data-hull-template='createtopic/createtopic'>
        <h1>Do you want to add an image to that topic?</h1>
        <div data-hull-component="uploads/image@hull" data-hull-id="{{topic.id}}"></div>
                <button type="button" id="skipimageupload" data-hull-action="skipimageupload">No thanks!</button>
    </script>
    
    <script type='text/x-handlebars' data-hull-template='post/post'}>
        <button type="button" id="back" data-hull-action="back">&lt&ltBack</button>
        <button type="button" id="deleteTopic" data-hull-action="deleteTopic">Delete Topic</button>
        <button type="button" id="updateImage" data-hull-action="updateImage">Upload Image</button>

        <h1>{{post.name}}</h1>
        {{#if post.picture}}
            <img src="{{imageUrl post.picture 'large' 'http://placehold.it/200x200'}}"/> 
        {{/if}}
        
        <input type="text" id="postTags"></input>
        <button type="button" id="updateTags" data-hull-action="updateTags">Update Tags</button>
	<p>{{post.stats.comments}} comments</p>
        <h1>Top Comments</h1>
        <div class="loading">
            <img src="https://f.cloud.github.com/assets/6652042/2208623/dcefa538-9981-11e3-895e-5a09c35c265d.gif" alt="Loading" width="42" height="42"> 
        </div>
        <div data-hull-component="test" data-hull-id="{{post.id}}" data-hull-orderby="votes"></div>
        <h1>New Comments</h1>
         <div class="loading">
            <img src="https://f.cloud.github.com/assets/6652042/2208623/dcefa538-9981-11e3-895e-5a09c35c265d.gif" alt="Loading" width="42" height="42"> 
        </div>
        <div data-hull-component="test" data-hull-id="{{post.id}}" data-hull-orderby="date"></div>
        

	<div class="under">
        <h1>Posts under {{post.name}}</h1>
        {{#each postsUnder}}
            {{#if picture}}
                <img src="{{imageUrl picture 'small' 'http://placehold.it/200x200'}}"/> 
            {{/if}}
            <h1><a href="#/post/{{id}}">{{name}}</a></h1>
            {{#if tags}}
                Tags:
                {{#each tags}}
                    {{#if this}}
                        <li><a href="#/post/{{this.value}}">{{this.label}}</a></li>
                    {{/if}}
                {{/each}}
            {{/if}}
	    <p>{{stats.comments}} comments</p>
            <div data-hull-component="test" data-hull-id="{{id}}" data-hull-orderby="votes"></div>
        {{/each}}
        </div>
        
        <div class="related">
        <h1>Posts related to {{post.name}}</h1>
        {{#each postsRelated}}
             {{#if picture}}
                <img src="{{imageUrl picture 'small' 'http://placehold.it/200x200'}}"/> 
            {{/if}}
            <h1><a href="#/post/{{id}}">{{name}}</a></h1>
            <p>{{stats.comments}} comments</p>
        {{/each}}
    </script>
        </div>
    <script type='text/handlebars' data-hull-template='test/test'>
        {{> test/form}}
    
    {{#if comments}}
      <ul class="media-list hull-comments__list">
        {{#comments}}
          <li class="media" data-hull-comment-id="{{id}}">
            <div class="pull-left">
              <img class="media-object img-rounded" src="{{user.picture}}" alt="{{user.name}}" width="50" height="50">
            </div>
            <div class="media-body">
              <h4 class="media-heading"><a href="#/user/{{user.id}}">{{user.name}}</a>
 <small class="muted"> â€¢ {{fromNow updated_at}}</small></h4>
              <div class="hull-comments__description">
                {{description}}
              </div>
              {{#if extra.richComment}}
              	{{{extra.richComment}}}
              {{/if}}
              <div class="hull-comments__actions">
                  {{#if isDeletable}}
                    <small>
                      <a href="#" class='link' data-hull-action="delete" data-hull-id="{{id}}">Delete</a>
                    </small>
                  {{/if}}
                  <small>
                    <a href="#" class='link text-error' data-hull-action="flag" data-hull-id="{{id}}">Inappropriate?</a>
                  </small>
                   <div data-hull-component="ratings/vote@hull" data-hull-id="{{id}}"></div>
              </div>
            </div>
          </li>
        {{/comments}}
      </ul>
          <button type="button" id="loadMore" data-hull-action="loadMore">Load More Comments</button>
    {{/if}}
    
    {{^comments}}
      <div class="alert alert-info">
        No comments for the moment
      </div>
    {{/comments}}
    </script>
        
    <script type='text/handlebars' data-hull-template='ratings/vote/vote'>
        {{#if loggedIn}}
          <div class='btn-group'>
          Upvote
        <button class="btn btn-small {{outputIf myVote 1 'btn-success'}} dropup" data-hull-action='{{outputIf myVote 1 'unvote' 'upvote'}}'><span class='caret'></span>&nbsp;{{votes.up}}</button>
          Downvote
        <button class="btn btn-small {{outputIf myVote -1 'btn-success'}} dropdown" data-hull-action='{{outputIf myVote -1 'unvote' 'downvote'}}'><span class='caret'></span>&nbsp;{{votes.down}}</button>
      </div>
    {{else}}
      <div data-hull-component="login_button@hull"></div>
    {{/if}}
    </script>
    
    <script type='text/handlebars' data-hull-template='test/form'>
        <div class="well">
      {{#if loggedIn}}
        <form>
          <div class='media'>
            <div class="pull-left">
              <img class="media-object img-rounded" src="{{me.picture}}" alt="{{me.name}}" width="42" height="42">
            </div>
            <div class="media-body">
              <div class="linkPreview" id="lp1"></div>
              <div>
                <div class='pull-right'>
                  <small>
                  </small>
                </div>
              </div>
            </div>
          </div>
        </form>
      {{/if}}
    </div>
    </script>
    <div class="loading">
       <img src="https://f.cloud.github.com/assets/6652042/2208623/dcefa538-9981-11e3-895e-5a09c35c265d.gif" alt="Loading" width="42" height="42"> 
    </div>
    <div data-hull-component="posts"></div>        
          
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.3.0/handlebars.min.js"></script>
    <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
    <script src="//documentcloud.github.io/underscore/underscore.js"></script>
    <script src="//documentcloud.github.io/backbone/backbone-min.js"></script>
    <script src="//d3f5pyioow99x0.cloudfront.net/0.8/hull.js"></script>
    <script src="//xoxco.com/projects/code/tagsinput/jquery.tagsinput.js"></script>
		
	</div>
	<div class="col2">
		
	</div>
</div>

	<script>
        
        Hull.component('posts', {
            templates: ['posts', 'post', 'user', 'search', 'createtopic'],
            initialize: function(){
                var tab = this.$el.parent().find('.loading');
                tab.slideDown();
        
                this.options.limit = 5;
                this.options.trendingDaysLimit = 30;    //3 days
                this.options.trendingLimit = 10;    //10 posts
                var HullagramRouter = Backbone.Router.extend({
                    routes: {
                        ':view(/:id)(/:action)' : 'view'
                    }
                });
            
                var router  = new HullagramRouter();
                router.on('route:view', function(view, id, action) {
                    console.log('current view:' + view);
                    console.log('currrent id:' + id);
                    var tpl = action || view || 'posts';
                    this.currentView = tpl;
                    this.render(tpl, { id: id });
                }, this);
        
                this.sandbox.on('hullagram.route', function(route) {
                    router.navigate(route, { trigger: true });
                });
        
                setTimeout(function() {
                    Backbone.history.start();
                }, 200);
        
            }, //initialize
            datasources: {
                newPosts: function() {
                    return this.api('52e138eaf0f1b0ac30000bad/conversations', 'get', {
                        'visibiliy': 'public',
                        limit: this.options.limit,
                        order_by: 'created_at DESC'
                     });
                },
                trendingPosts: function loadTrendingPosts() {
                    var dff = $.Deferred();
                    var result = [];
                    var componenet = this;
                    var timeFrame = "this_" + this.options.trendingDaysLimit + "_days";
                    Keen.onChartsReady(function() {
                        var metric = new Keen.Metric("hull.comment.create", {
                            analysisType: "count",
                            groupBy: "target_id",
                            timeframe: timeFrame
                        });
                
                      //Get the result of the query and alert it.
                        metric.getResponse(function(response){
                            var numberOfPosts = componenet.options.trendingLimit;
                            if(response.result.length >= componenet.options.trendingLimit) {
                                response.result.sort(function(a,b) {
                                    return b.result - a.result;
                                });
                                
                                console.log(response.result);
                                for(var i = 0; i< componenet.options.trendingLimit; i++)
                                {
                                    componenet.api(response.result[i].target_id, 'get').then(function(response) {
                                        result.push(response);
                                    }, function(error) {
                                        numberOfPosts--;
                                    });
                                }
                                (function wait(){
                                    if(result.length >= numberOfPosts) {
                                        dff.resolve(result);
                                    } else {
                                        setTimeout(wait, 100);
                                    }
                                })();
                            }
                            else {    //We need to fetch more data from Keen
                                console.log("fetching more data from Keen");
                                componenet.options.trendingDaysLimit += 5;
                                componenet.render();
                            }
                        });    //end of keen response
                    });
                    return dff.promise();
                }
            },  
            beforeRender: function(data) {
                data.currentView = this.currentView;
                return data;
            },
            afterRender: function() {
                var tab = this.$el.parent().find('.loading:first');
                tab.slideUp();
               
            },
            actions: {
                loadMore: function() {
                    this.options.limit += 10;
                    this.render();
                },
                loadMoreTrending: function() {

                        this.options.trendingLimit += 10;
                        this.render();
                    
                }
            }
        });    //posts component
        
        Hull.component('user', {
            templates: ['user'],
            datasources: {
                feed: function() {
                    var dff = $.Deferred(); 
                    var component = this;
                    component.api('/following/' + component.options.id, 'put').then(function(response) {
                        component.api('app/following_activity', 'get', {
                            where: {
                                'actor_id': component.options.id,
                                'obj_type': { $in: ['Comment', 'Review'] }
                            },
                            limit: 1000
                        }).then(function(response) {
                            dff.resolve(response);
                        });        
                    });
                    return dff.promise();
                }
            },
            beforeRender: function(data, errors) {
                console.log(data);
            },
            actions: {
                back: function() {
                    window.location.href = '#/posts/nbmbn';
                }
            }
        });
        
            Hull.component('createtopic', {
            templates: ['createtopic'],
            datasources: {
                topic: ':id'
            },
            afterRender: function() {
                var component = this;
                this.sandbox.on('hull.uploads.image.finished', function(image) {                  
                    component.api(component.options.id, 'put',{
                            "picture": image.id
                        }).then(function() {
                        window.location.href = '#/post/'+ component.options.id;
                    });                    
                });
            },
            actions: {
                skipimageupload: function() {
                    window.location.href = '#/post/'+ component.options.id;
                }
            }
        });
        
        Hull.component('search', {
            templates: ['search'],
            initialize: function() {
                console.log(this.options.search);
            },
            datasources: {
                searchResults: function() {
                var searchString = this.options.search;
        //searchString.replace(/(the|it is|we all|an?|by|to|you|[mh]e|she|they|we)/ig, '');
                var searchTokens = searchString.split(/[ ,]+/);
                console.log(searchTokens);
                return this.api('52e138eaf0f1b0ac30000bad/conversations', 'get', {
                                'visibiliy': 'public',
                                where:{
                                    'name': {
                                        '$regex': '.*('+ searchTokens.join('|') +').*', '$options': 'i'
                                    }
                                }
                             });
                }
            },
            beforeRender: function(data, error) {
                console.log(data);
            },
            actions: {
                back: function() {
                    window.location.href = '#/posts';
                }       
            }
        });
        
        Hull.component('test', {
            templates: ['test', 'form'],

            refreshEvents: ['model.hull.me.change'],
            
            requiredOptions: ['id'],
            
            events: {
            'keyup [name="description"]' : 'checkButtonStatus'
            },
            
            
            actions: {
            comment: 'postComment',
            'delete':  'deleteComment',
            flag:    'flagItem',
            loadMore: function() {
                this.options.limit += 10;
                this.render();
                }
            },  
            options: {
            focus: false,
            perPage: 10,
            page: 1
            },
            
            datasources: {
            	post: ':id',
            	comments: function() {
                    var orderBy;
                    if(this.options.orderby == 'votes') {
                        orderBy = 'stats.reviews.updown DESC';
                    } else if(this.options.orderby == 'date') {
                        orderBy = 'created_at DESC';
                    }
                    return this.api(this.options.id + '/comments', {
                        limit: this.options.limit,
                        order_by: orderBy
                     }); 
                }
            },
            
            initialize: function() {
            this.options.limit = 5;
            var query = {};
            
            if (this.options.startPage) {
            query.page = this.options.startPage;
            } else {
            query.skip = this.options.skip || 0;
            }
            
            this.sandbox.on('hull.comments.' + this.options.id + ".**", function() {
            this.render()
            }, this);
            
            query.limit = this.options.limit || this.options.perPage;
            this.query = query;
            },
            
            checkButtonStatus: function() {
            var disabled = !this.$find('[name="description"]').val();
            //this.$find('[data-hull-action="comment"]').attr('disabled', disabled);
            },
            
            beforeRender: function(data) {
            this.sandbox.util._.each(data.comments, function(c) {
            c.isDeletable = (c.user.id === data.me.id);
            return c;
            }, this);
            return data;
            },
            
            afterRender: function(data) {
            
            console.log(data);
            var tab = this.$el.parent().find('.loading');
            tab.slideUp();
            
            var linkPreviewDiv = this.$el.find('#lp1');
            if(linkPreviewDiv.children().length == 0) {
            	linkPreviewDiv.linkPreview({objectID: this.options.id, objectName: data.post.name, component: this});
            }
            
            this.$el.find(".imgIframe").click(function() {
            	var oldId = $(this).attr("id");
                var currentId = oldId.substring(4);
                pTP = "pTP_" + currentId;
                pDP = "pDP_" + currentId;
                oldId = "#" + oldId;
                currentId = "#" + currentId;
                $(oldId).css({
                	'display' : 'none'
                });
                $(currentId).css({
                    'display' : 'block'
                });
                $('#' + pTP).css({
                    'width' : '495px'
                });
                $('#' + pDP).css({
                    'width' : '495px'
                });
            });
                    
            if(this.options.focus || this.focusAfterRender) {
            this.$el.find('input,textarea').focus();
            this.focusAfterRender = false;
            }
            this.checkButtonStatus();
            },
            
            deleteComment: function(event, action) {
            event.preventDefault();
            var id = action.data.id;
            var $parent = action.el
            .addClass('is-removing')
            .parents('[data-hull-comment-id="'+ id +'"]');
            this.api(id, 'delete').then(function () {$parent.remove();});
            },
            
            toggleLoading: function () {
            this.$el.toggleClass('is-loading');
            this.$find('input,textarea,button').attr('disabled', this.$el.hasClass('is-loading'));
            },
            
            postComment: function (e) {
            e.preventDefault();
            var self = this;
            var $form = this.$find('form');
   
            formData = this.sandbox.dom.getFormData($form);
            
            //if (formData.description && formData.description.length > 0) {
            this.toggleLoading();
            this.api(this.options.id + '/comments', 'post', {
            	"description": "Rich Comment",
            	"extra": {
            		"richComment": richComment
            	}
            }).then(function(comment) {
            self.sandbox.emit('hull.comments.' + self.options.id + '.added', comment);
            self.toggleLoading();
            self.focusAfterRender = true;
            self.render();
            }, function() {
            self.$el.find('input,textarea').focus();
            self.toggleLoading();
            });
            //}
            },
            
            flagItem: function (event, action) {
            event.preventDefault();
            var id = action.data.id;
            var isCertain = confirm('Do you want to report this content as inappropriate ?');
            if (isCertain) {
            this.sandbox.flag(id);
            }
            }
        });
        
        Hull.component('post', {
            templates: ['post'],
            datasources: {
                post: ':id',
                postsUnder: function() {
                    return this.api('52e138eaf0f1b0ac30000bad/conversations', 'get', {
                        'visibiliy': 'public',
                        where:{
                          'tags.value':this.options.id,
                        },
                        limit: 1000
                     });
                },
                postsRelated: function() {
                    var dff = $.Deferred();
                    var result = [];
                    var tagsProcessed = 0;
                    var numberOfTags = 0;
                    var componentRef = this;
                    this.api(this.options.id, 'get').then(function(response) {
                    if(response.tags) {
                        numberOfTags = response.tags.length;
                        $.each(response.tags, function(tagsIndex, tagValue){
                            console.log("tag value");
                            console.log(tagValue);
                            componentRef.api('52e138eaf0f1b0ac30000bad/conversations', 'get', {
                        'visibiliy': 'public',
                        where:{
                          'tags.value':tagValue.value
                        }                     
                        }).then(function(response){
                                console.log("related tag");
                                console.log(response);
                                $.each(response, function(responseIndex, responseValue){
                                    if(responseValue.id != componentRef.options.id) {
                                        result.push(responseValue);
                                    }
                                });
                                console.log("Tags proccessed:"+ ++tagsProcessed);
                            });
                        });
        
                        (function wait(){
                            if(tagsProcessed == numberOfTags) {
                                console.log("Tags processing completed!");
                                dff.resolve(result);
                            } else {
                                setTimeout(wait, 100);
                            }
                        })();
                      }
                    else {
                        dff.resolve(result);
                    }
                  });            
                  return dff.promise();
                }
            },    
            initialize: function(data) {
                console.log("init");
                console.log(data);
                console.log(data);
            },
            beforeRender: function (data, errors) {
                console.log("before render");
                console.log(data);
                console.log("Before render errors:" + errors);
            },
            afterRender: function (data) {
                var tab = this.$el.parent().find('.loading:first');
                tab.slideUp();
        
                console.log("after render");
                console.log(data);
                var tagsElement = $('#postTags');
                tagsElement.tagsInput({
                    'autocomplete_url': arr,
                    'autocomplete': {select: function(event, ui){
                        tagsElement.addTag(ui.item.label);
                        tagsElement.removeTag(ui.item.value);
                    }},
                    'height':'100px',
                    'width':'300px',
                    'interactive':true,
                    'defaultText':'add a tag',
                    'removeWithBackspace' : true,
                    'minChars' : 0,
                    'maxChars' : 0,
                    'placeholderColor' : '#666666'
                });
                if(this.data.post.attributes.tags) {
                   $.each(this.data.post.attributes.tags, function (tagIndex, tagValue) {
                       tagsElement.addTag(tagValue.label);
                   });
                }
            },
            actions: {
                deleteTopic: function() {
                    Hull.api(this.options.id, 'delete').then(function(response) {
                    console.log(response);
                    });
                    window.location.href = '#/posts/nbmbn';
                },
                back: function() {
                    window.location.href = '#/posts/nbmbn';
                },
                updateTags: function() {
                    var tagsText = $('.tagsinput').eq(1).prev().val(); 
                    var tagsPromise = processTags(tagsText);
                    var postID = this.options.id;
                    tagsPromise.done(function(result){
                        Hull.api(postID, 'put',{
                            "tags": result
                        }).then(function(response) {
                            console.log(response);
                            window.location.href = '#/posts/nbmbn';
                        });
                    });
                },
                updateImage: function() {
                    window.location.href = '#/createtopic/' + this.options.id;
                }
            }
        }); //post component
        
        var arr;
        
        Hull.init({
            debug: false, //Enable to see all traces from the app
            appId : "52e0c2a06b2de9b464000590",
            orgUrl: "https://d291172a.hullapp.io"
        }, function(hull, me, app, org){
        
            console.log('Here we go!');
            
            hull.api('52e138eaf0f1b0ac30000bad/conversations', 'get', {
                        'visibiliy': 'public'
            }).then(function(response) {
                console.log('conversations', response);

                arr = $.map(response, function(elementOfArray, indexInArray){
                    if(elementOfArray.name){
                        var datum = {
                        label: elementOfArray.name,
                        value: elementOfArray.id
                        }
                        return datum;
                    }
                });
        
                $( "#searchField" ).autocomplete({
                    source: arr,
                    select: function(event, ui) {
                        event.preventDefault();
                        $(this).val(ui.item.label);
                        window.location.href = '#/post/' + ui.item.value;
                    }
                });
                
                $('#tagsField').tagsInput({
                    'autocomplete_url': arr,
                    'autocomplete': {select: function(event, ui){
                        $('#tagsField').addTag(ui.item.label);
                        $('#tagsField').removeTag(ui.item.value);
                    }},
                    'height':'100px',
                    'width':'300px',
                    'interactive':true,
                    'defaultText':'add a tag',
                    'removeWithBackspace' : true,
                    'minChars' : 0,
                    'maxChars' : 0,
                    'placeholderColor' : '#666666'
                });
            }); //get conversations
        
        }); //Hull.init
        
        $('#createTopic').on('click', function(){
            var newConversationName = $('#newEntityField').val();
            if(newConversationName) {
                var tagsText = $('#tagsField').val();
                Hull.api('52e138eaf0f1b0ac30000bad/conversations', 'get', {
                    'visibiliy': 'public',
                    where:{
                        'name': {
                            '$regex': newConversationName, '$options': 'i'
                        }
                    }
                }).then(function(response) {
                    console.log(response);
                    if(response.length == 0) {
                        var tagsPromise = processTags(tagsText);
                        tagsPromise.done(function(result){
                            //create the new conversation
                            Hull.api('/52e138eaf0f1b0ac30000bad/conversations', 'post',{
                                "public": "true",
                                "name": newConversationName,
                                "tags": result
                            }).then(function(response) {
                                console.log(response);
                                window.location.href = '#/createtopic/' + response.id;
                            });
                        });
                    } else {
                        alert("A topic with the same name already exsits!");        
                    }
                });
            }
        });   //on click
        
        $('#search').on('click', function() {
            var searchTerm = $('#searchField').val();
            if(searchTerm) {
                window.location.href = '#/search/' + searchTerm;
            }
        });
        
        var processRelatedPosts = function(postID) {
            var dff = $.Deferred();
            var result = [];
            var tagsProcessed = 0;
            var numberOfTags = 0;
            Hull.api(postID, 'get').then(function(response) {
                numberOfTags = response.tags.length;
                $.each(response.tags, function(tagsIndex, tagValue){
                Hull.data.api('/52e138eaf0f1b0ac30000bad/conversations', 'get', {
                    'visibility':'public',
                    where:{
                    'tags.value':tagValue.value,
                    },
                    limit: 1000
                    }).then(function(response){
                        result = result.concat(response);
                        tagsProcessed++;
                    });
                });
                    (function wait(){
                    if(tagsProcessed == numberOfTags) {
                    dff.resolve(result);
                    } else {
                        setTimeout(wait, 100);
                    }
            })();
            });
          return dff.promise();
        };
        
        var processTags = function(tagsFieldText) {
            var dff = $.Deferred();
            var textTags = tagsFieldText.split(',');
                var numberOfTags = textTags.length;
                var tagsFinished = 0;
                var tagsWithID = [];
        
                $.each(textTags, function (indexTextTag, valueTextTag) {
                    if(valueTextTag.length >0) {
                        var temp = $.grep(arr, function (elementArr, indexArr){
                                        return elementArr.label == valueTextTag;
                                    });
                                    if(temp[0]){
                                        //Tag has anID
                                        tagsWithID.push(temp[0]);
                                        console.log("existing tag");
                                        console.log(++tagsFinished);
                                    } else {
                                        console.log("laaag");
                                        console.log(valueTextTag);
                                        //Tag does not have ID, create new Entity
                                    Hull.api('52e138eaf0f1b0ac30000bad/conversations', 'get', {
                                        'visibiliy': 'public',
                                        where:{
                                            'name': {
                                                '$regex': valueTextTag, '$options': 'i'
                                            }
                                        }
                                    }).then(function(response) {
                                        console.log("EEEH");
                                        console.log(response);
                                        if(response.length == 0) {
                                            Hull.api('/52e138eaf0f1b0ac30000bad/conversations', 'post',{
                                                "public": "true",
                                                "name": valueTextTag
                                            }).then(function(response) {
                                                console.log("Tag Created");
                                                var datum = {
                                                    label: valueTextTag,
                                                    value: response.id
                                                }
                                            tagsWithID.push(datum);
                                            console.log("new tag");
                                            console.log(++tagsFinished);
                                           });
                                        } else {
                                            tagsFinished ++;
                                             alert("A tag with the same name already exists!");
                                        }
                                    });
                                    }
                    } else {
                        tagsFinished ++;
                    }       
                });    //end of each
        
                (function wait(){
                    if(tagsFinished == numberOfTags) {
                        dff.resolve(tagsWithID);
                    } else {
                        setTimeout(wait, 100);
                    }
                })();
          return dff.promise();
        };
        
        
        (function(){

        
        })();
        
 </script>

           
        
	</script>
</body>
</html>
