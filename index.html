<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Zacomments</title>

		<meta name="referrer" content="always"/>
		<meta name="keywords" content="zacomments,comments,topics">
		<meta name="description" content="Your Zacomments all belong to us.">

		<meta property="og:site_name" content="Zacomments" />
		<meta property="og:type" content="website" />
		<meta property="og:url" content="https://zacomments.com" />
		<meta property="og:title" content="Zacomments" />
		<meta property="og:description" content="Your Zacomments all belong to us." />
		
	    <link rel="stylesheet" type="text/css" href="css/styles.css">

		<script type="text/javascript">
		    var Keen=Keen||{configure:function(e){this._cf=e},addEvent:function(e,t,n,i){this._eq=this._eq||[],this._eq.push([e,t,n,i])},setGlobalProperties:function(e){this._gp=e},onChartsReady:function(e){this._ocrq=this._ocrq||[],this._ocrq.push(e)}};(function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://":"http://")+"dc8na2hxrj29i.cloudfront.net/code/keen-2.1.0-min.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})();
		
		    // Configure the Keen object with your Project ID and (optional) access keys.
		    Keen.configure({
		        projectId: "52c6e20836bf5a6dd0000015",
		        writeKey: "d523d28ca0cf1406ac6a4275d70c09f31e06fa575355a163f411a81ae4b9caabc73c211a53c93c14286da3e33ebfcb3696e8e5973da40ac16035c28c8f8c38eabcdc6fa15f2474edc748212d748475a62d59d6bcf9479b6b10fa187ae42f1245663fedbeabcc6af28df2dec0f2ff5b0d", // required for sending events
		        readKey: "98ec71562a7174440c4b628f1871282e333dd4e7df76994e3ebc269f49bea6bc356b567e8db69b5a0735d3bd3221cf31ebf5c4c780e61a5388f1550616536c286ecbdad69994dd51c183333c05e7fbe0f51ed695301c7470f6e3cceb2ca5db9c3d81593f41dd26419d5e96460f44380c"    // required for doing analysis
		    });
		</script>
		
	</head>
	
	<body>
		
		<header>
			
			<a href="#/maincomp"><img class="logo" src="css/logo.svg"/></a>
			
			<form class="search">			
				<input  type="text" id="searchField" id="tags"></input>
		    	<button type="button" id="search">Search</button>
	    	</form>
	    	
	    	<div class="login" data-hull-component="mylogin" data-hull-provider="facebook,twitter"></div>
			
		</header>
					
		<div data-hull-component="maincomp"></div>   
	    
	    <script type='text/handlebars' data-hull-template='maincomp/maincomp'>
	        {{#if isAdmin}}
	            <div data-hull-component="flaggedposts"></div>
	        {{/if}}
	        <main>
		        <section data-hull-component="posts"></section> 
				<aside data-hull-component="newposts"></aside>
	        </main>
	    </script>
	            
	    <script type='text/x-handlebars' data-hull-template='posts/posts'>
	        {{#if loggedIn}}
	    		<div data-hull-component="createtopicform"></div>
	    	{{/if}}
	    	
			<h3>Trending Buzz</h3>
	    
	        {{#each trendingPosts}}
	        	{{#if name}}
					<article>
						
		        		<div class="topic">
			                <h1 data-postID="{{id}}"><a href="#/post/{{id}}">{{name}}</a></h1>
			                
			                <ul>
				                <li>{{stats.comments}} comments</li>
			                {{#if tags}}
			                    {{#each tags}}
			                        {{#if this}}
			                        	<li><a href="#/post/{{this.value}}">{{this.label}}</a></li>
			                        {{/if}}
			                    {{/each}}
			                {{/if}}
								<li><a href="#" class='link text-error' data-hull-action="flag" data-hull-id="{{id}}">Inappropriate?</a></li>
			                </ul>	
			                <div class="img">
								<img src="{{imageUrl picture 'original' extra.fallbackUrl}}"/> 
			                </div>
						</div>
		        	
						<div data-hull-component="commentbox" data-hull-id="{{id}}"></div>
						<div data-hull-component="test" data-hull-id="{{id}}" data-hull-orderby="votes"></div>
		        		
	        		</article>
	            {{/if}}
	        {{/each}}
	       
	        <button type="button" id="loadMoreTrending" data-hull-action="loadMoreTrending">Load more posts</button>			
	    </script>
	    		    			
		<script type='text/x-handlebars' data-hull-template='newposts/newposts'>
		
	    	<h3>New Buzz</h3>
	    
			{{#each newPosts}}
				{{#if name}}
					<article>
						
						<div class="topic">
							<h1 data-postID="{{id}}"><a href="#/post/{{id}}">{{name}}</a></h1>
							
							<ul>
								<li>{{stats.comments}} comments</li>
							{{#if tags}}
								{{#each tags}}
									{{#if this}}
										<li><a href="#/post/{{this.value}}">{{this.label}}</a></li>
									{{/if}}
								{{/each}}
							{{/if}}
								<li><a href="#" class='link text-error' data-hull-action="flag" data-hull-id="{{id}}">Inappropriate?</a></li>
							</ul>
							<div class="img">
								<img src="{{imageUrl picture 'original' extra.fallbackUrl}}"/>
							</div> 
						</div>

						<div data-hull-component="commentbox" data-hull-id="{{id}}"></div>
						<div data-hull-component="test" data-hull-id="{{id}}" data-hull-orderby="votes"></div>
						
					</article>
				{{/if}}
			{{/each}}
			
			<button type="button" id="loadMore" data-hull-action="loadMore">Load more posts</button>
			
	    </script>
	    
	    <script type='text/x-handlebars' data-hull-template='mylogin/mylogin'>
	    {{#if authHasFailed}}
		  <div class="alert alert-error">
		    There was an error signing in your account. Maybe you did not approve the app?
		  </div>
	    {{/if}}
		
		{{#if matchingProviders}}
		  <div class='media'>
		    {{#if me.picture}}
		    <div class="pull-left">
		      <img class="media-object img-rounded" src="{{me.picture}}" alt="{{me.name}}" width="70px" height="70px">
		    </div>
		    {{/if}}
		    <div class="pull-right">
		      <a data-hull-action="logout" class="btn">Log Out</a>
		    </div>
		    <div class="media-body">
		      <span class="media-heading">{{me.name}}</span>
		    </div>
		  </div>
		
		{{else}}
		  {{#if loggedOut}}
		    <div class="hull-identity__signin">
		      {{#loggedOut}}
		        <button data-hull-action="login" data-hull-provider="{{.}}" class="btn btn-small btn-{{.}}">
		          <i class="icon-{{.}}"></i>
		          Sign In with {{classify .}}
		        </button>
		      {{/loggedOut}}
		    </div>
		  {{/if}}
		{{/if}}
	    </script>	
	    
	    <script type='text/x-handlebars' data-hull-template='flaggedposts/flaggedposts'>
    		<h3>Flagged Posts</h3>
    		{{#each flaggedPosts}}
    		<h1 data-postID="{{id}}"><a href="#/post/{{id}}">{{name}}</a></h1>
    		<img src="{{imageUrl picture 'original' extra.fallbackUrl}}"/>
    		<ul>
    			<li><a href="#" class='link text-error' data-hull-action="unflag" data-hull-id="{{id}}">Unflag</a></li>
				<li><a href="#" class='link text-error' data-hull-action="deleteItem" data-hull-id="{{id}}">Delete</a></li>
    		</ul>
			{{/each}}
	    </script>
	    
	    <script type='text/x-handlebars' data-hull-template='maincomp/post'}>
	    	{{#if loggedIn}}
			<div data-hull-component="createtopicform"></div>
	        {{/if}}
	        <main data-hull-component="post" data-hull-id="{{id}}"></main>
	    </script>
	    
	    <script type='text/x-handlebars' data-hull-template='user/user'}>
	    	<div class="user">
		    	<img src={{feed.0.actor.picture}}>
		        <h1>{{feed.0.actor.name}}</h1>
		        {{#each feed}}
	    			<div class="comment">
		    			<ul>
		            {{#ifEqual object.type "comment"}}
		                {{#if target.name}}
		                <li><a href="#/comment/{{object.id}}">Commented</a> on <a href="#/post/{{target.id}}">{{target.name}}</a></li>
		                {{/if}}
		            {{else}}
		                <li>Reviewed a <a href="#/comment/{{object.reviewable_id}}">comment</a> on a post</li>
		            {{/ifEqual}}
		            	<ul>
	    			</div>
		        {{/each}}
	    	</div>
	    </script>
	    
	    <script type='text/x-handlebars' data-hull-template='search/search'}>
	    	<section>
		        <h3>Search Results</h3>
		        {{#ifEqual searchResults.length 0}}
		        	<p>No results were found</p>
		        {{else}}
			        {{#each searchResults}}
			            {{#if name}}
			            <div class="topic">
			                <h1 class="post" data-postID="{{id}}"><a href="#/post/{{id}}">{{name}}</a></h1>
			                <ul>
								<li>{{stats.comments}} comments</li>
								<li><a href="#" class='link text-error' data-hull-action="flag" data-hull-id="{{id}}">Inappropriate?</a></li>
			                </ul>
			                <div class="img">
								<img class="postimg" src="{{imageUrl picture 'original' extra.fallbackUrl}}"/>
							<div class="img">
			            </div>
			            {{/if}}
			        {{/each}}
		        {{/ifEqual}}
	    	</section>
	    </script>
	    
	    <script type='text/x-handlebars' data-hull-template='maincomp/user'}>
	        {{#if loggedIn}}
				<div data-hull-component="createtopicform"></div>
				<main data-hull-component="user" data-hull-id="{{id}}"></main>
			{{else}}
			<main>
	        	<h3>You need to login to view user feed</h3>
	    		<div data-hull-component="mylogin" data-hull-provider="facebook"></div>
			</main>
	        {{/if}}
	    </script>
	    
	    <script type='text/x-handlebars' data-hull-template='maincomp/search'}>
	        {{#if loggedIn}}
			<div data-hull-component="createtopicform"></div>
			{{/if}}
	        <main data-hull-component="search" data-hull-search="{{id}}"></main>
	    </script>
	    
	    <script type='text/x-handlebars' data-hull-template='maincomp/createtopic'}>
	        <div data-hull-component="createtopic" data-hull-id="{{id}}"></div>
	    </script>
	        
	    <script type='text/x-handlebars' data-hull-template='createtopic/createtopic'>
	        <h3>Do you want to add an image to that topic?</h1>
	        <p>Use Image URL</p>
	        <input type="text" id="imageURL"></input>
	        <button type="button" id="updateImage" data-hull-action="updateimage">Update Image</button>
	        
	        <h3>Or</h3>
	        <p>Upload an Image</p>
	        <div data-hull-component="uploads/image@hull" data-hull-id="{{topic.id}}"></div>
	        <button type="button" id="skipimageupload" data-hull-action="skipimageupload">No thanks</button>
	    </script>
	    
	    <script type='text/x-handlebars' data-hull-template='maincomp/comment'}>
	        {{#if loggedIn}}
			<div data-hull-component="createtopicform"></div>
			{{/if}}
	        <div data-hull-component="comment" data-hull-id="{{id}}"></div>
	    </script>
	       
	    <script type='text/x-handlebars' data-hull-template='comment/comment'}>
	    
	    	<img src="{{imageUrl post.picture 'large' post.extra.fallbackUrl}}"/>
	    	
	     	<div class="comment">
	        	<img src="{{comment.user.picture}}" alt="{{comment.user.name}}">
	        	<div>
					<span><a href="#/user/{{comment.user.id}}">{{comment.user.name}}</a></span>
					<p>{{comment.description}}</p>
					<ul>
				 		<li>{{fromNow comment.updated_at}}</li>
				 		<li>{{post.stats.comments}} comments</li>
				 		<li data-hull-component="ratings/vote@hull" data-hull-id="{{comment.id}}"></li>
				 		<li>on<a href="#/post/{{post.id}}">{{post.name}}</a></li>
				 	</ul>
	        	</div>
			</div>
			
	    </script>
	    		     
	    <script type='text/handlebars' data-hull-template='createtopicform/createtopicform'>
	    	<form>
		    	<input type="text" placeholder="Topic title" id="newEntityField"></input>
		    	<input type="text" placeholder="Add some tags" id="tagsField"></input>
		    	<button type="button" id="createTopic" data-hull-action="createtopic" disabled>Create</button>
	    	</form>
	    </script>
	    
	    <script type='text/x-handlebars' data-hull-template='post/post'}>
	        {{#if isAdmin}}
	        	<button type="button" id="deleteTopic" data-hull-action="deleteTopic">Delete Topic</button>
	        	<button type="button" id="updateImage" data-hull-action="updateImage">Upload Image</button>
	        {{/if}}
	        
	        <section>
	        
	        	<article>
			        <div class="topic">
				        <h1 id="postTitle">{{post.name}}</h1>
				        
				        <ul>
					        <li>{{post.stats.comments}} comments</li>
							<li><a href="#" class='link text-error' data-hull-action="flag" data-hull-id="{{post.id}}">Inappropriate?</a></li>
				        </ul>
				        <div class="img">
				        	<img src="{{imageUrl post.picture 'large' post.extra.fallbackUrl}}"/>
				        </div> 
				    </div>

			        <form>
				        <input type="text" id="postTags"></input>
			        </form>

			        {{#if isAdmin}}
			        	<button type="button" id="updateTags" data-hull-action="updateTags">Update Tags</button>
			        {{/if}}
			        
					<div data-hull-component="commentbox" data-hull-id="{{post.id}}"></div>
			        
					<p>Top Comments</p>
					<div data-hull-component="test" data-hull-id="{{post.id}}" data-hull-orderby="votes"></div>
			        
				    <p>New Comments</p>
					<div data-hull-component="test" data-hull-id="{{post.id}}" data-hull-orderby="date"></div>
				</article>	    
				    
		    </section>
		        
	        <aside>
		        
	       		<h3>Posts under {{post.name}}</h3>

				{{#ifEqual postsUnder.length 0}}
		        <p>No posts currently tagged with {{post.name}}</p>
		        {{/ifEqual}}
		        {{#each postsUnder}}
		        <div class="topic">
		        	<h1><a href="#/post/{{id}}">{{name}}</a></h1>
					<ul>
						<li>{{stats.comments}} comments</li>
	            {{#if tags}}
	                {{#each tags}}
	                    {{#if this}}
	                        <li><a href="#/post/{{this.value}}">{{this.label}}</a></li>
	                    {{/if}}
	                {{/each}}
	            {{/if}}
	            		<li><a href="#" class='link text-error' data-hull-action="flag" data-hull-id="{{id}}">Inappropriate?</a></li>
	            	</ul>
	            	<div class="img">
						<img src="{{imageUrl picture 'original' extra.fallbackUrl}}"/>
		        	</div>
		    	</div>
		    
				<div data-hull-component="commentbox" data-hull-id="{{id}}"></div>
		        <div data-hull-component="test" data-hull-id="{{id}}" data-hull-orderby="votes"></div>
		            
		        {{/each}}
			    
			</aside>
	    
	    </script>
	        
	    <script type='text/handlebars' data-hull-template='test/test'>
	
	    {{#if comments}}
	    <div class="media-list hull-comments__list">
	        {{#comments}}
			<div class="comment" data-hull-comment-id="{{id}}">
	            <img src={{user.picture}}>
	            <!--<input id="lp1"></input>-->
	            <div>
	            	<span><a href="#/user/{{user.id}}">{{user.name}}</a></span>
				  	<p class="hull-comments__description">
				  	{{description}}
				  	</p>
	              	<ul class="hull-comments__actions">
					  	<li class="muted">{{fromNow updated_at}}</li>
	                  	<li data-hull-component="ratings/vote@hull" data-hull-id="{{id}}"></li>
	              		{{#if isDeletable}}
	              		<li><a href="#" class='link' data-hull-action="delete" data-hull-id="{{id}}">Delete</a></li>
	              		{{/if}}
	                  	<li><a href="#" class='link text-error' data-hull-action="flag" data-hull-id="{{id}}">Inappropriate?</a></li>
                	</ul> 
				</div>
			</div>
			{{/comments}}
			
		
	    	{{^comments}}
				<span>No more comments</span>
			{{/comments}}   
	    	
			{{#ifEqual options.showLoadMoreButton true}}
	        <button type="button" id="loadMore" data-hull-action="loadMore">Load more comments</button>
			{{/ifEqual}}
		{{/if}}
		</div>
		
	    </script>
	        
	    <script type='text/handlebars' data-hull-template='ratings/vote/vote'>
	        {{#if loggedIn}}
	        <ul class='btn-group'>
	          <li>Upvote<button class="btn btn-small {{outputIf myVote 1 'btn-success'}} dropup" data-hull-action='{{outputIf myVote 1 'unvote' 'upvote'}}'>&nbsp;{{votes.up}}</button></li>
	          <li>Downvote<button class="btn btn-small {{outputIf myVote -1 'btn-success'}} dropdown" data-hull-action='{{outputIf myVote -1 'unvote' 'downvote'}}'>&nbsp;{{votes.down}}</button></li>
	        </ul>
			{{else}}
			<div data-hull-component="login_button@hull"></div>
			{{/if}}
	    </script>
	    
	    <script type='text/handlebars' data-hull-template='test/form'>
	      {{#if loggedIn}}
	        <form>
					<img src="{{me.picture}}" alt="{{me.name}}" width="42" height="42">
		            <input id="lp1"></div>
	        </form>
	      {{/if}}
	    </script>
	    
	    <script type='text/handlebars' data-hull-template='commentbox/commentbox'>
		  {{#if loggedIn}}
		    <form>
					<img src="{{me.picture}}" alt="{{me.name}}">
	            	<input id="lp1"></div>
		    </form>
		  {{/if}}
	    </script>
	    
		<script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
		<script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.3.0/handlebars.min.js"></script>
		<script src="//documentcloud.github.io/underscore/underscore.js"></script>
		<script src="//documentcloud.github.io/backbone/backbone-min.js"></script>
		<script src="//d3f5pyioow99x0.cloudfront.net/0.8/hull.js"></script>
	    <script src="js/jquery.tagsinput.js"></script>
		<script src="js/components.js"></script>

		<script>
	        var arr;
	        var rawAllTopics;
	        
	        Hull.init({
	            debug: false, //Enable to see all traces from the app
	            appId : "52e0c2a06b2de9b464000590",
	            orgUrl: "https://d291172a.hullapp.io"
	        }, function(hull, me, app, org){
	        
	            console.log('Here we go!');
	            
	            hull.api('52e138eaf0f1b0ac30000bad/conversations', 'get', {
	                        'visibiliy': 'public',
	                        'limit': 1000
	            }).then(function(response) {
	            	console.log("Number of items "  + response.length);
			rawAllTopics = response;
			
	                arr = $.map(response, function(elementOfArray, indexInArray){
	                    if(elementOfArray.name){
	                        var datum = {
	                        label: elementOfArray.name,
	                        value: elementOfArray.id
	                        }
	                        return datum;
	                    }
	                });
	        	
	                $( "#searchField" ).autocomplete({
	                    source: arr,
	                    select: function(event, ui) {
	                        event.preventDefault();
	                        $(this).val(ui.item.label);
	                        window.location.href = '#/post/' + ui.item.value;
	                    }
	                });
	                
	                $('#searchField').keyup(function(e){
	    			if(e.keyCode == 13)
	    			{
	    				var searchTerm = $(this).val();
	    				if(searchTerm) {
	    					window.location.href = '#/search/' + searchTerm;
	    				}
	    			}
			});
	                
	            }); //get conversations
	            
	            console.log("Flagged items");
	            Hull.api('/52e138eaf0f1b0ac30000bad/conversations', {
	            	'where': {
	            		'meta.flags': {
	            			'$gt': 0
	            		}
	            	}
	            }).then(function(response){
	            	console.log(response);
	            });
	        
	        }); //Hull.init
	        
	        $('#search').on('click', function() {
	            var searchTerm = $('#searchField').val();
	            if(searchTerm) {
	                window.location.href = '#/search/' + searchTerm;
	            }
	        });
	        
	        var trim = function (str) {
	            return str.replace(/^\s+|\s+$/g, "");
	        };
	        
	        var processRelatedPosts = function(postID) {
	            var dff = $.Deferred();
	            var result = [];
	            var tagsProcessed = 0;
	            var numberOfTags = 0;
	            Hull.api(postID, 'get').then(function(response) {
	                numberOfTags = response.tags.length;
	                $.each(response.tags, function(tagsIndex, tagValue){
	                Hull.data.api('/52e138eaf0f1b0ac30000bad/conversations', 'get', {
	                    'visibility':'public',
	                    where:{
	                    'tags.value':tagValue.value,
	                    },
	                    limit: 1000
	                    }).then(function(response){
	                        result = result.concat(response);
	                        tagsProcessed++;
	                    });
	                });
	                    (function wait(){
	                    if(tagsProcessed == numberOfTags) {
	                    dff.resolve(result);
	                    } else {
	                        setTimeout(wait, 100);
	                    }
	            })();
	            });
	          return dff.promise();
	        };
	        
	        var processTags = function(tagsFieldText) {
	            var dff = $.Deferred();
	            var textTags = tagsFieldText.split(',');
	                var numberOfTags = textTags.length;
	                var tagsFinished = 0;
	                var tagsWithID = [];
	        
	                $.each(textTags, function (indexTextTag, valueTextTag) {
	                    if(valueTextTag.length >0) {
	                        var temp = $.grep(arr, function (elementArr, indexArr){
	                                        return elementArr.label == valueTextTag;
	                                    });
	                                    if(temp[0]){
	                                        //Tag has anID
	                                        tagsWithID.push(temp[0]);
	                                        console.log("existing tag");
	                                        console.log(++tagsFinished);
	                                    } else {
	                                        console.log("laaag");
	                                        console.log(valueTextTag);
	                                        //Tag does not have ID, create new Entity
	                                    Hull.api('52e138eaf0f1b0ac30000bad/conversations', 'get', {
	                                        'visibiliy': 'public',
	                                        where:{
	                                            'name': {
	                                                '$regex': '^' + valueTextTag  + '$', '$options': 'i'
	                                            }
	                                        }
	                                    }).then(function(response) {
	                                        console.log("EEEH");
	                                        console.log(response);
	                                        if(response.length == 0) {
	                                            Hull.api('/52e138eaf0f1b0ac30000bad/conversations', 'post',{
	                                                "public": "true",
	                                                "name": valueTextTag
	                                            }).then(function(response) {
	                                                console.log("Tag Created");
	                                                var datum = {
	                                                    label: valueTextTag,
	                                                    value: response.id
	                                                }
	                                            tagsWithID.push(datum);
	                                            console.log("new tag");
	                                            console.log(++tagsFinished);
	                                           });
	                                        } else {
	                                            tagsFinished ++;
	                                             alert("A tag with the same name already exists!");
	                                             $('.createbuzz').children().removeAttr("disabled");
	                                        }
	                                    });
	                                    }
	                    } else {
	                        tagsFinished ++;
	                    }       
	                });    //end of each
	        
	                (function wait(){
	                    if(tagsFinished == numberOfTags) {
	                        dff.resolve(tagsWithID);
	                    } else {
	                        setTimeout(wait, 100);
	                    }
	                })();
	          return dff.promise();
	        };
	        
	        var notAlreadyAdded = function(collection, element) {
	        	var result = true;
	                for(var i = 0; i < collection.length; i++) {
	                    if(collection[i].id == element) {
	                        result = false;
	                        break;
	                    }
	                }
	                return result;
	        };
	            
	        (function(){
	        
	        })();
 		</script>
 		
 	</body>
</html>
